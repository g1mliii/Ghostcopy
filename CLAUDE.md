# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

GhostCopy is a cross-platform clipboard synchronization tool built with Flutter. Desktop (Windows/macOS) runs as an invisible background utility with a "Spotlight-style" popup triggered by global hotkey. Mobile (iOS/Android) serves as a receiver with push notifications and home screen widgets.

## Build & Development Commands

```bash
# Get dependencies
flutter pub get

# Run on specific platform
flutter run -d windows
flutter run -d macos
flutter run -d android
flutter run -d ios

# Build release
flutter build windows
flutter build macos
flutter build apk
flutter build ios

# Run tests
flutter test

# Run single test file
flutter test test/unit/services/transformer_service_test.dart

# Analyze code
flutter analyze
```

## Architecture

### Client-Server Model
- **Backend**: Supabase (PostgreSQL + Realtime + Auth + RLS)
- **Sync**: Bidirectional via Supabase Realtime subscriptions
- **Auth**: Email/password via Supabase Auth with Row Level Security

### Service-Based Architecture
All features are implemented as services with abstract interfaces for testability:
- `IWindowService` - Borderless window management, show/hide Spotlight
- `IHotkeyService` - Global keyboard shortcut registration
- `ITrayService` - System tray icon and context menu
- `IClipboardRepository` - Supabase CRUD operations
- `ILifecycleController` - Sleep Mode resource management
- `ITransformerService` - Content type detection (JSON, JWT, hex colors)
- `IGameModeService` - Notification suppression during fullscreen apps
- `IAutoReceiveService` - Desktop auto-copy from other devices

### Key Patterns

**Sleep Mode (Zero-CPU)**: When Spotlight is hidden, pause all TickerProviders and non-essential streams. Only hotkey listener stays active. Implement `Pausable` interface for pausable resources.

**Bidirectional Sync Flow**:
- Desktop → Mobile: Hotkey → Spotlight → Send → Push notification → Auto-copy
- Mobile → Desktop: Paste into app → Send → Realtime → Auto-copy to clipboard

**Smart Transformers**: Detect content types and offer enhancements:
- JSON: Prettify button with 2-space indentation
- JWT: Decode and display payload/expiration
- Hex colors: Show color preview square

## UI Design System

**Theme**: Dark + glassmorphism, inspired by Discord and Blip

**Colors** (see `lib/ui/theme/colors.dart`):
```dart
background: Color(0xFF0D0D0F)    // Deep black
surface: Color(0xFF1A1A1D)       // Card surfaces
primary: Color(0xFF5865F2)       // Purple-blue accent (Discord-like)
success: Color(0xFF3BA55C)       // Green confirmations
```

**Typography**: Inter for UI, JetBrains Mono for code/JSON

**Spotlight Window**: 500px wide, max 400px height, 12px border radius, discord and blip as inspiration.

**Animations**:
- Spotlight appear: fade + scale from 0.95 (150ms ease-out)
- Button hover: scale 1.02 + brightness
- Toast: slide in from bottom-right
- History items: staggered fade-in

## Project Structure

```
lib/
├── main.dart
├── models/           # Data models (ClipboardItem, AppState)
├── services/         # Business logic services
├── repositories/     # Data access layer (Supabase)
└── ui/
    ├── theme/        # Colors, typography, app theme
    ├── widgets/      # Reusable components
    └── screens/      # Full screens (spotlight, history, settings)

test/
├── unit/             # Unit tests
└── property/         # Property-based tests (glados)
```

## Testing

- **Framework**: `flutter_test` + `glados` for property-based testing
- **Property tests**: Minimum 100 iterations, tag with `**Feature: ghostcopy, Property N: description**`
- Use `const` widgets where possible to reduce rebuilds

## Key Packages

| Package | Purpose |
|---------|---------|
| `supabase_flutter` | Auth, Database, Realtime |
| `window_manager` | Borderless window, hide/show |
| `hotkey_manager` | Global keyboard shortcuts |
| `tray_manager` | System tray icon and menu |
| `launch_at_startup` | Auto-start on login |
| `dart_jsonwebtoken` | JWT decoding |
| `glados` | Property-based testing |

## Environment Setup

Create `.env` file in project root:
```
SUPABASE_URL=your-project-url
SUPABASE_ANON_KEY=your-anon-key
```

## Platform Notes

**Windows**: Hotkeys and tray work out of the box

**macOS**: Requires Accessibility permissions for global hotkeys. Configure App Sandbox entitlements for network access.

**Mobile**: Cannot auto-detect clipboard changes (OS restriction). Use paste-to-send flow. Push notifications require FCM/APNs setup.

## Database Schema

```sql
CREATE TABLE clipboard (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  user_id uuid REFERENCES auth.users NOT NULL,
  content text NOT NULL,
  device_name text,
  device_type text NOT NULL,  -- 'windows', 'macos', 'android', 'ios'
  is_public boolean DEFAULT false,
  created_at timestamptz DEFAULT timezone('utc', now())
);

-- RLS enabled with user-scoped policies
```

## Implementation Status

See `new text document.txt` for full implementation plan with checkboxes.
