# Supabase Setup Guide

## Initial Setup

### 1. Create Supabase Project
1. Go to [supabase.com](https://supabase.com) and create a new project
2. Note your project URL and anon key from Settings > API

### 2. Run Database Schema
Execute this SQL in the SQL Editor:

```sql
-- Create clipboard table
CREATE TABLE clipboard (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  user_id uuid REFERENCES auth.users NOT NULL,
  content text NOT NULL,
  device_name text,
  device_type text NOT NULL,
  is_public boolean DEFAULT false,
  created_at timestamptz DEFAULT timezone('utc'::text, now())
);

-- Enable Row Level Security
ALTER TABLE clipboard ENABLE ROW LEVEL SECURITY;

-- RLS Policies
CREATE POLICY "Users can view own items" ON clipboard
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own items" ON clipboard
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can delete own items" ON clipboard
  FOR DELETE USING (auth.uid() = user_id);

-- Index for efficient history queries
CREATE INDEX idx_clipboard_user_created ON clipboard(user_id, created_at DESC);
```

### 3. Enable Realtime
1. Go to Database > Replication
2. Click on "0 tables" under Source
3. Select the `clipboard` table
4. Toggle **INSERT** and **UPDATE** to ON

### 4. Configure Authentication
1. Go to Authentication > Providers
2. Enable Email provider (enabled by default)
3. Optionally enable OAuth providers (Google, Apple, etc.)

## Environment Configuration

Create a `.env` file (don't commit to git):
```
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your-anon-key-here
```

Or use `--dart-define` for builds:
```bash
flutter run --dart-define=SUPABASE_URL=https://your-project.supabase.co --dart-define=SUPABASE_ANON_KEY=your-key
```

## Flutter Integration

### Initialize Supabase
```dart
// main.dart
import 'package:supabase_flutter/supabase_flutter.dart';

Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  await Supabase.initialize(
    url: const String.fromEnvironment('SUPABASE_URL'),
    anonKey: const String.fromEnvironment('SUPABASE_ANON_KEY'),
  );
  
  runApp(const GhostCopyApp());
}

// Access client anywhere
final supabase = Supabase.instance.client;
```

### Insert Clipboard Item
```dart
Future<void> sendToCloud(String content, String deviceName, String deviceType) async {
  await supabase.from('clipboard').insert({
    'user_id': supabase.auth.currentUser!.id,
    'content': content,
    'device_name': deviceName,
    'device_type': deviceType,
  });
}
```

### Stream History (Realtime)
```dart
Stream<List<ClipboardItem>> watchHistory({int limit = 50}) {
  return supabase
    .from('clipboard')
    .stream(primaryKey: ['id'])
    .eq('user_id', supabase.auth.currentUser!.id)
    .order('created_at', ascending: false)
    .limit(limit)
    .map((data) => data.map((e) => ClipboardItem.fromJson(e)).toList());
}
```

### Fetch History (One-time)
```dart
Future<List<ClipboardItem>> getHistory({int limit = 50}) async {
  final response = await supabase
    .from('clipboard')
    .select()
    .eq('user_id', supabase.auth.currentUser!.id)
    .order('created_at', ascending: false)
    .limit(limit);
  
  return response.map((e) => ClipboardItem.fromJson(e)).toList();
}
```

## Authentication

### Sign Up
```dart
Future<void> signUp(String email, String password) async {
  await supabase.auth.signUp(
    email: email,
    password: password,
  );
}
```

### Sign In
```dart
Future<void> signIn(String email, String password) async {
  await supabase.auth.signInWithPassword(
    email: email,
    password: password,
  );
}
```

### Check Auth State
```dart
bool get isAuthenticated => supabase.auth.currentUser != null;

// Listen to auth changes
supabase.auth.onAuthStateChange.listen((data) {
  final event = data.event;
  if (event == AuthChangeEvent.signedIn) {
    // User signed in
  } else if (event == AuthChangeEvent.signedOut) {
    // User signed out
  }
});
```

## Push Notifications (Mobile)

For mobile push notifications when new clips arrive, you'll need to set up Supabase Edge Functions or use a third-party service. The basic flow:

1. Store FCM/APNs tokens in a `user_devices` table
2. Create a database trigger or Edge Function that fires on INSERT
3. Send push notification to all user's devices except the sender

This is an advanced topic - implement after core functionality works.

## Troubleshooting

### "permission denied for table clipboard"
- Check that RLS is enabled and policies are created
- Verify user is authenticated before making requests

### Realtime not working
- Verify Realtime is enabled for the table in Dashboard
- Check that you're using `.stream()` not `.select()`
- Ensure the Supabase client is initialized before subscribing

### Data not appearing
- Check browser console / Flutter logs for errors
- Verify the user_id matches the authenticated user
- Test queries directly in Supabase SQL Editor
